apiVersion: v1
stringData:
  kw_admin_key: {{kw_admin_key}}
  kw_read_only_key: {{kw_read_only_key}}
  kw_write_key: {{kw_write_key}}
  gui_access_key: {{gui_access_key}}
kind: Secret
metadata:
  name: {{deployment_id}}-secret
  kalavai.job.name: {{deployment_id}}
type: Opaque
immutable: true
---
apiVersion: batch.volcano.sh/v1alpha1
kind: Job
metadata:
  name: {{deployment_id}}
  labels:
    # must have this label
    kalavai.job.name: {{deployment_id}}
spec:
  queue: default
  schedulerName: volcano
  plugins:
    env: []
    svc: ["--disable-network-policy=true"]
  maxRetry: 100000
  tasks:
  - replicas: 1   # One ps pod specified
    name: watcher
    maxRetry: 100000
    policies:
    - event: PodEvicted
      action: RestartJob
    - event: PodFailed
      action: RestartJob
    - event: TaskCompleted
      action: RestartJob
    - event: Unknown
      action: RestartJob
    template: # Definition of the ps pod
      metadata:
        labels:
          role: leader
          kalavai.job.name: {{deployment_id}}
      spec:
        nodeSelector:
          kalavai/role: server
        terminationGracePeriodSeconds: 60
        containers:
        - name: watcher
          image: docker.io/kalavai/kube-watcher:{{watcher_version}}:latest
          env:
          - name: KW_ADMIN_KEY
            valueFrom:
              secretKeyRef:
                name: {{deployment_id}}-secret
                key: kw_admin_key
          - name: KW_READ_ONLY_KEY
            valueFrom:
              secretKeyRef:
                name: {{deployment_id}}-secret
                key: kw_read_only_key
          - name: KW_WRITE_KEY
            valueFrom:
              secretKeyRef:
                name: {{deployment_id}}-secret
                key: kw_write_key
          - name: IN_CLUSTER
            value: "True"
          - name: KW_USE_AUTH
            value: "True"
          - name: ALLOW_UNREGISTERED_USER
            value: "{{watcher_allow_unregistered_user}}"
          - name: deployment.nodeSelector.{{kalavai_role_label}}
            value: "server"
          ports:
          - containerPort: 8000
            name: model-port
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 10
          resources:
            requests:
              cpu: 1
              memory: 1Gi
            limits:
              cpu: 1
              memory: 1Gi
  - replicas: 1
    name: gui
    maxRetry: 100000
    policies:
    - event: PodEvicted
      action: RestartJob
    - event: PodFailed
      action: RestartJob
    - event: TaskCompleted
      action: RestartJob
    - event: Unknown
      action: RestartJob
    template: # Definition of worker pods
      metadata:
        labels:
          kalavai.job.name: {{deployment_id}}
      spec:
        terminationGracePeriodSeconds: 60
        containers:
        - name: gui
          image: docker.io/kalavai/kalavai-gui:latest
          command:
          - sh
          - -c
          - |
            KALAVAI_BRIDGE_URL=`cat /etc/volcano/backend.host`;
            KALAVAI_BRIDGE_PORT=49152;
            reflex run
          env:
          - name: ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: {{deployment_id}}-secret
                key: gui_access_key
          resources:
            requests:
              cpu: 1
              memory: 1Gi
            limits:
              cpu: 1
              memory: 1Gi
        restartPolicy: OnFailure
  - replicas: 1
    name: backend
    maxRetry: 100000
    policies:
    - event: PodEvicted
      action: RestartJob
    - event: PodFailed
      action: RestartJob
    - event: TaskCompleted
      action: RestartJob
    - event: Unknown
      action: RestartJob
    template: # Definition of worker pods
      metadata:
        labels:
          kalavai.job.name: {{deployment_id}}
          role: gui
      spec:
        terminationGracePeriodSeconds: 60
        containers:
        - name: kalavai-backend
          image: docker.io/python:3.12-slim
          command:
          - sh
          - -c
          - |
            pip install kalavai-client
            # set credentials
            WATCHER_ADDRESS=`cat /etc/volcano/watcher.host`;
            echo "{\"server_ip\": \"$WATCHER_ADDRESS\", \"watcher_admin_key\": \"$KW_ADMIN_KEY\", \"watcher_readonly_key\": \"\", \"watcher_write_key\": \"\", \"watcher_service\": \"$WATCHER_ADDRESS:8000\", \"node_name\": \"\", \"cluster_name\": \"\", \"public_location\": null, \"user_api_key\": null}" > ~/.cache/kalavai/.server 
            kalavai gui start --log-level debug --backend-only
          env:
          - name: KW_ADMIN_KEY
            valueFrom:
              secretKeyRef:
                name: {{deployment_id}}-secret
                key: kw_admin_key
          - name: KW_READ_ONLY_KEY
            valueFrom:
              secretKeyRef:
                name: {{deployment_id}}-secret
                key: kw_read_only_key
          - name: KW_WRITE_KEY
            valueFrom:
              secretKeyRef:
                name: {{deployment_id}}-secret
                key: kw_write_key
          ports:
          - containerPort: 49153
            name: gui-port
          resources:
            requests:
              cpu: 1
              memory: 1Gi
            limits:
              cpu: 1
              memory: 1Gi
        restartPolicy: OnFailure
---
# deploy NodePort to expose model (if not using LiteLLM registration)
apiVersion: v1
kind: Service
metadata:
  name: {{deployment_id}}-service
  labels:
    # must have this!
    kalavai.job.name: {{deployment_id}}
spec:
  type: NodePort
  selector:
    role: gui
    kalavai.job.name: {{deployment_id}}
  ports:
    - name: main
      port: 49153
      targetPort: 49153
      protocol: TCP
      nodePort: {{guiport}}